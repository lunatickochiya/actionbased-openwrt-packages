From 8cda36ba8ac7749c2d41bad2e88bc77c1ddc1521 Mon Sep 17 00:00:00 2001
From: lunatickochiya <125438787@qq.com>
Date: Sun, 16 Feb 2025 09:32:05 +0800
Subject: [PATCH] revert adv

---
 luci-app-advancedplus/Makefile                |  4 +-
 .../luasrc/controller/advancedplus.lua        |  1 +
 .../model/cbi/advancedplus/advancedipk.lua    |  1 -
 .../model/cbi/advancedplus/advancedset.lua    | 13 ++++++
 .../model/cbi/advancedplus/argon-config.lua   | 10 ++---
 .../model/cbi/advancedplus/kucatset.lua       |  6 +--
 .../po/zh-cn/advancedplus.po                  | 12 ++++--
 .../po/zh_Hans/advancedplus.po                | 12 ++++--
 .../root/etc/config/advancedplus              |  2 +-
 luci-app-advancedplus/root/etc/config/argon   |  7 ++--
 .../root/etc/init.d/advancedplus              | 35 ++++++++++++----
 .../root/etc/uci-defaults/luci-advancedplus   |  2 +-
 .../root/usr/bin/advancedplusipk              | 41 +++++++++----------
 .../share/ucitrack/luci-app-advancedplus.json |  4 --
 14 files changed, 91 insertions(+), 59 deletions(-)
 delete mode 100644 luci-app-advancedplus/root/usr/share/ucitrack/luci-app-advancedplus.json

diff --git a/luci-app-advancedplus/Makefile b/luci-app-advancedplus/Makefile
index f9523055c..a34172e9e 100644
--- a/luci-app-advancedplus/Makefile
+++ b/luci-app-advancedplus/Makefile
@@ -1,5 +1,5 @@
 #
-# Copyright 2023-2025 sirpdboy team <herboy2008@gmail.com>
+# Copyright 2023-2024 sirpdboy team <herboy2008@gmail.com>
 # This is free software, licensed under the Apache License, Version 2.0 .
 #
 
@@ -7,7 +7,7 @@ include $(TOPDIR)/rules.mk
 NAME:=advancedplus
 PKG_NAME:=luci-app-$(NAME)
 LUCI_TITLE:=LuCI support for Kucat theme setting by sirpdboy
-LUCI_DEPENDS:=+luci-compat +curl +wget
+LUCI_DEPENDS:=+luci-compat +curl
 LUCI_PKGARCH:=all
 
 
diff --git a/luci-app-advancedplus/luasrc/controller/advancedplus.lua b/luci-app-advancedplus/luasrc/controller/advancedplus.lua
index ed087356e..a9021bb71 100644
--- a/luci-app-advancedplus/luasrc/controller/advancedplus.lua
+++ b/luci-app-advancedplus/luasrc/controller/advancedplus.lua
@@ -53,6 +53,7 @@ end
 
 function advanced_run()
 	local selectipk = luci.http.formvalue('select_ipk')
+	luci.sys.exec("echo  'start' > /tmp/advancedplus.log&&echo  'start' > /tmp/advancedpos")
 	uci:set(name, 'advancedplus', 'select_ipk', selectipk)
 	uci:commit(name)
 	fs.writefile("/tmp/advancedpos","0")
diff --git a/luci-app-advancedplus/luasrc/model/cbi/advancedplus/advancedipk.lua b/luci-app-advancedplus/luasrc/model/cbi/advancedplus/advancedipk.lua
index 1deb8ab74..0328fff76 100644
--- a/luci-app-advancedplus/luasrc/model/cbi/advancedplus/advancedipk.lua
+++ b/luci-app-advancedplus/luasrc/model/cbi/advancedplus/advancedipk.lua
@@ -3,7 +3,6 @@ LuCI - Lua Configuration Interface
  Copyright (C) 2022-2024  sirpdboy <herboy2008@gmail.com> https://github.com/sirpdboy/luci-app-advancedplus
 ]]--
 
-luci.sys.exec("echo '-' >/tmp/advancedplus.log&&echo 1 > /tmp/advancedpos" )
 local fs = require "nixio.fs"
 local uci=luci.model.uci.cursor()
 local m,s,e
diff --git a/luci-app-advancedplus/luasrc/model/cbi/advancedplus/advancedset.lua b/luci-app-advancedplus/luasrc/model/cbi/advancedplus/advancedset.lua
index 842c3e2f3..3139f91e2 100644
--- a/luci-app-advancedplus/luasrc/model/cbi/advancedplus/advancedset.lua
+++ b/luci-app-advancedplus/luasrc/model/cbi/advancedplus/advancedset.lua
@@ -10,6 +10,19 @@ translate("</br>For specific usage, see:")..translate("<a href=\'https://github.
 
 t = a:section(TypedSection, "basic", translate("Settings"))
 t.anonymous = true
+e = t:option(Flag, "qos",translate('Qos automatic optimization'), translate('Enable QOS automatic optimization strategy (testing function)'))
+e.default = "0"
+e.rmempty = false
+
+dl = t:option(Value, "download", translate("Download bandwidth(Mbit/s)"))
+dl.default = '200'
+dl:depends("qos", true)
+
+ul = t:option(Value, "upload", translate("Upload bandwidth(Mbit/s)"))
+ul.default = '30'
+ul:depends("qos", true)
+
+e = t:option(Flag, "uhttps",translate('Accessing using HTTPS'), translate('Open the address in the background and use HTTPS for secure access'))
 
 e = t:option(Flag, "usshmenu",translate('No backend menu required'), translate('OPENWRT backend and SSH login do not display shortcut menus'))
 
diff --git a/luci-app-advancedplus/luasrc/model/cbi/advancedplus/argon-config.lua b/luci-app-advancedplus/luasrc/model/cbi/advancedplus/argon-config.lua
index 4edb6d187..4d59b0797 100644
--- a/luci-app-advancedplus/luasrc/model/cbi/advancedplus/argon-config.lua
+++ b/luci-app-advancedplus/luasrc/model/cbi/advancedplus/argon-config.lua
@@ -50,17 +50,15 @@ local transparency_sets = {
 }
 
 -- [[ 模糊设置 ]]--
-br = SimpleForm('config', translate('Argon configuration'), translate('Here you can set the blur and transparency of the login page of argon theme, and manage the background pictures and videos.[Chrome is recommended]'))
+br = SimpleForm('config', translate('Argon Config'), translate('Here you can set the blur and transparency of the login page of argon theme, and manage the background pictures and videos.[Chrome is recommended]'))
 br.reset = false
 br.submit = false
 s = br:section(SimpleSection) 
 
 o = s:option(ListValue, 'bing_background', translate('Wallpaper Source'))
-o:value('none', translate('Built-in'))
-o:value('bing', translate('Bing'))
-o:value('unsplash', translate('Unsplash'))
-o:value('wallhaven', translate('Wallhaven'))
-o.default = 'none'
+o:value('0', translate('Built-in'))
+o:value('1', translate('Bing Wallpapers'))
+o.default = bing_background
 o.rmempty = false
 
 o = s:option(ListValue, 'mode', translate('Theme mode'))
diff --git a/luci-app-advancedplus/luasrc/model/cbi/advancedplus/kucatset.lua b/luci-app-advancedplus/luasrc/model/cbi/advancedplus/kucatset.lua
index ac8ac2e73..bf52be463 100644
--- a/luci-app-advancedplus/luasrc/model/cbi/advancedplus/kucatset.lua
+++ b/luci-app-advancedplus/luasrc/model/cbi/advancedplus/kucatset.lua
@@ -85,12 +85,12 @@ e.rmempty = false
 e = t:option(Value, 'gossr', translate('Services Ssrkey settings'))
 e:value('shadowsocksr', translate('SSR'))
 e:value('bypass', translate('bypass'))
-e:value('nikki', translate('nikki[Mihomo]'))
+e:value('vssr', translate('Hello World'))
 e:value('passwall', translate('passwall'))
 e:value('passwall2', translate('passwall2'))
 e:value('openclash', translate('OpenClash'))
-e:value('homeproxy', translate('HomeProxy'))
-e:value('vssr', translate('Hello World'))
+e:value('chatgpt-web', translate('Chatgpt Web'))
+e:value('ddns-go', translate('DDNS-GO'))
 e.default = 'bypass'
 e.rmempty = false
 
diff --git a/luci-app-advancedplus/po/zh-cn/advancedplus.po b/luci-app-advancedplus/po/zh-cn/advancedplus.po
index 63173ed9d..49d9aebb6 100644
--- a/luci-app-advancedplus/po/zh-cn/advancedplus.po
+++ b/luci-app-advancedplus/po/zh-cn/advancedplus.po
@@ -8,12 +8,13 @@ msgstr "进阶设置"
 msgid "KuCat Theme Config"
 msgstr "KuCat主题设置"
 
-msgid "Argon configuration"
+msgid "Argon Config"
 msgstr "Argon主题设置"
 
 msgid "Design Config"
 msgstr "Design主题设置"
 
+
 msgid "Advanced Setting"
 msgstr "高级设置"
 
@@ -89,9 +90,6 @@ msgstr "壁纸透明度"
 msgid "Follow System"
 msgstr "跟随系统"
 
-msgid "Inital Setup"
-msgstr "设置向导"
-
 msgid "Refreshing mode"
 msgstr "清爽模式"
 
@@ -110,6 +108,12 @@ msgstr "展开导航栏"
 msgid "Expand or shrink the toolbar"
 msgstr "展开或者收缩导航栏"
 
+msgid "Color palette"
+msgstr "调色板工具"
+
+msgid "Call up your favorite color value tool (note: HEX and RGB colors)"
+msgstr "调出自己喜欢的颜色值工具(注意:HEX和RGB值区别)"
+
 msgid "Light"
 msgstr "亮色"
 
diff --git a/luci-app-advancedplus/po/zh_Hans/advancedplus.po b/luci-app-advancedplus/po/zh_Hans/advancedplus.po
index 63173ed9d..49d9aebb6 100644
--- a/luci-app-advancedplus/po/zh_Hans/advancedplus.po
+++ b/luci-app-advancedplus/po/zh_Hans/advancedplus.po
@@ -8,12 +8,13 @@ msgstr "进阶设置"
 msgid "KuCat Theme Config"
 msgstr "KuCat主题设置"
 
-msgid "Argon configuration"
+msgid "Argon Config"
 msgstr "Argon主题设置"
 
 msgid "Design Config"
 msgstr "Design主题设置"
 
+
 msgid "Advanced Setting"
 msgstr "高级设置"
 
@@ -89,9 +90,6 @@ msgstr "壁纸透明度"
 msgid "Follow System"
 msgstr "跟随系统"
 
-msgid "Inital Setup"
-msgstr "设置向导"
-
 msgid "Refreshing mode"
 msgstr "清爽模式"
 
@@ -110,6 +108,12 @@ msgstr "展开导航栏"
 msgid "Expand or shrink the toolbar"
 msgstr "展开或者收缩导航栏"
 
+msgid "Color palette"
+msgstr "调色板工具"
+
+msgid "Call up your favorite color value tool (note: HEX and RGB colors)"
+msgstr "调出自己喜欢的颜色值工具(注意:HEX和RGB值区别)"
+
 msgid "Light"
 msgstr "亮色"
 
diff --git a/luci-app-advancedplus/root/etc/config/advancedplus b/luci-app-advancedplus/root/etc/config/advancedplus
index 8865af9a8..295aaf64c 100644
--- a/luci-app-advancedplus/root/etc/config/advancedplus
+++ b/luci-app-advancedplus/root/etc/config/advancedplus
@@ -7,7 +7,7 @@ config basic
 	option font_d '1.1rem'
 	option font_z '0.92rem'
 	option font_x '0.875rem'
-	option bklock '0'
+	option bklock '1'
 	option setbar '1'
 	option dayword '0'
 	option background '0'
diff --git a/luci-app-advancedplus/root/etc/config/argon b/luci-app-advancedplus/root/etc/config/argon
index 04fbff7c7..fb7f35d9c 100644
--- a/luci-app-advancedplus/root/etc/config/argon
+++ b/luci-app-advancedplus/root/etc/config/argon
@@ -1,10 +1,9 @@
 config global
 	option primary '#5e72e4'
 	option dark_primary '#483d8b'
-	option progressbar_font '#2e2b60'
 	option blur '10'
 	option blur_dark '10'
-	option transparency '0.2'
-	option transparency_dark '0.2'
+	option transparency '0.5'
+	option transparency_dark '0.5'
 	option mode 'normal'
-	option online_wallpaper 'none'
+	option bing_background '0'
diff --git a/luci-app-advancedplus/root/etc/init.d/advancedplus b/luci-app-advancedplus/root/etc/init.d/advancedplus
index 35bead83e..e4dd2c908 100644
--- a/luci-app-advancedplus/root/etc/init.d/advancedplus
+++ b/luci-app-advancedplus/root/etc/init.d/advancedplus
@@ -6,6 +6,9 @@ STOP=15
 EXTRA_COMMANDS='reset'
 EXTRA_HELP="        reset   Reset to default settings"
 
+ipt=$(command -v iptables-legacy || command -v iptables)
+ip6t=$(command -v ip6tables-legacy || command -v ip6tables)
+
 reset() {
 rm -rf /etc/config/advancedplus
 cat <<EOF  >/etc/config/advancedplus
@@ -18,7 +21,7 @@ config basic
 	option font_d '1.1rem'
 	option font_z '0.92rem'
 	option font_x '0.875rem'
-	option bklock '0'
+	option bklock '1'
 	option setbar '1'
 	option dayword '0'
 	option background '0'
@@ -172,9 +175,11 @@ set_firewall_wan() {
     ## 设置防火墙wan 打开
     uci -q set firewall.@zone[1].input='ACCEPT'
     uci commit firewall
+    /etc/init.d/firewall reload
     else
     uci -q set firewall.@zone[1].input='REJECT'
     uci commit firewall
+    /etc/init.d/firewall reload
     fi
 }
 
@@ -182,9 +187,11 @@ set_ttyd() {
     if [ "x$(uci -q get advancedplus.@basic[0].set_ttyd)" = "x1" ] ; then
     uci delete ttyd.@ttyd[0].interface
     uci commit
+    /etc/init.d/firewall reload
     else
     uci -q set ttyd.@ttyd[0].interface='@lan'
     uci commit
+    /etc/init.d/firewall reload
     fi
 }
 

diff --git a/luci-app-advancedplus/root/etc/uci-defaults/luci-advancedplus b/luci-app-advancedplus/root/etc/uci-defaults/luci-advancedplus
index d4cb27fe2..27c4f9225 100644
--- a/luci-app-advancedplus/root/etc/uci-defaults/luci-advancedplus
+++ b/luci-app-advancedplus/root/etc/uci-defaults/luci-advancedplus
@@ -7,7 +7,7 @@ uci -q batch <<-EOF >/dev/null
 	commit ucitrack
 EOF
 # sed -i 's/cbi.submit\"] = true/cbi.submit\"] = \"1\"/g' /usr/lib/lua/luci/dispatcher.lua
-[ "x$(uci -q get advancedplus.@basic[0].mode)" = "x" ]  && /etc/config/advancedplus reset
+[ "x$(uci -q get advancedplus.@basic[0].mode)" = "x" ]  && /etc/config/advancedplus reset 
 [ -s /usr/lib/lua/luci/view/themes/argon/sysauth.htm ] && sed -i 's,media .. \"\/b,resource .. \"\/b,g' /usr/lib/lua/luci/view/themes/argon/sysauth.htm
 rm -f /tmp/luci-indexcache
 exit 0
diff --git a/luci-app-advancedplus/root/usr/bin/advancedplusipk b/luci-app-advancedplus/root/usr/bin/advancedplusipk
index 894a51436..c93a6ef27 100644
--- a/luci-app-advancedplus/root/usr/bin/advancedplusipk
+++ b/luci-app-advancedplus/root/usr/bin/advancedplusipk
@@ -1,4 +1,4 @@
-#!/bin/bash
+#!/bin/sh
 
 skin="Kucat"
 
@@ -40,7 +40,7 @@ is_free() {
 
 istore_install(){
     if is_iStore; then
-        echo "已存在有iStore应用商店,无须再安装！"
+        echo "已经内置iStore应用商店,无须安装！"
      else
        echo "正在安装iStore应用商店...."
 	remove_check_signature



From 36b210be9662ba4106817e3943fcbfecef524945 Mon Sep 17 00:00:00 2001
From: lunatickochiya <125438787@qq.com>
Date: Sun, 16 Feb 2025 10:08:07 +0800
Subject: [PATCH 1/2] fix21 1

---
 .../root/etc/init.d/advancedplus              | 26 +++++++++----
 .../root/usr/bin/advancedplusipk              | 37 +++++++++----------
 2 files changed, 37 insertions(+), 26 deletions(-)

diff --git a/luci-app-advancedplus/root/etc/init.d/advancedplus b/luci-app-advancedplus/root/etc/init.d/advancedplus
index dc5f41603..e4dd2c908 100644
--- a/luci-app-advancedplus/root/etc/init.d/advancedplus
+++ b/luci-app-advancedplus/root/etc/init.d/advancedplus
@@ -216,15 +216,27 @@ dhcp_domain() {
     fi
 }
 advancedset(){
-    dev=`ifconfig | grep "Point-to-Point" | cut -d " " -f1`
-    [ ! $dev ] && dev=` uci -q get network.wan.device ` || dev=` uci -q get network.wan.device `
-    [ ! $dev ] && dev=br-lan
-    setnetwizard
-    set_ttyd
-    set_firewall_wan
-    tsoset
+dev=`ifconfig | grep "Point-to-Point" | cut -d " " -f1`
+[ ! $dev ] && dev=` uci -q get network.wan.device ` || dev=` uci -q get network.wan.device `
+[ ! $dev ] && dev=br-lan
+setnetwizard
+sethttps
+dhcp_domain
+set_ttyd
+set_firewall_wan
+tsoset
+    [ "x$(uci -q get advancedplus.@basic[0].qos)" = "x1" ] && \usr\bin\qoshome
+    if [ "x$(uci -q get advancedplus.@basic[0].ttl)" = "x1" ] ; then
+        $ipt -t mangle -A PREROUTING -p tcp --tcp-flags RST RST -i $dev -j DROP
+        $ipt -t mangle -A PREROUTING -i ${dev} -j TTL --ttl-inc 1
+        $ipt -t mangle -A POSTROUTING -o ${dev} -j TTL --ttl-set 64
+    fi
+    #cpumode=`uci -q get advancedplus.@basic[0].cpumode`
+    #[ ! $cpumode ] || cpumodeset $cpumode   /usr/bin/zsh
+if [ "$(which zsh)" ]; then
     sed -i "\/bin\/zsh/d" /etc/profile
     [ "x$(uci -q get advancedplus.@basic[0].usshmenu)" = "x1" ] || echo '/usr/bin/zsh'  >> /etc/profile
+fi
     uci commit netwizard
 }

diff --git a/luci-app-advancedplus/root/usr/bin/advancedplusipk b/luci-app-advancedplus/root/usr/bin/advancedplusipk
index 3314ef9ec..c93a6ef27 100644
--- a/luci-app-advancedplus/root/usr/bin/advancedplusipk
+++ b/luci-app-advancedplus/root/usr/bin/advancedplusipk
@@ -100,40 +100,39 @@ istore_install(){
                     sed -i '1s/$/ like iStoreOS/' /tmp/sysinfo/model
                 fi
             fi
-        uci -q set luci.main.mediaurlbase='/luci-static/kucat'
+        uci set luci.main.mediaurlbase='/luci-static/Kucat'
         uci commit
-	rm -rf /tmp/is-opkg /tmp/luci*
-        echo "iStore应用商店安装完成！"
+        opkg update
+	rm -rf /tmp/is-opkg
+        echo "iStore应用商店安装完成,需要重启OPENWRT才能生效！"
     fi
-    exit
 }

 drv_install(){
     if is_vip; then
-        bash /etc/kmodreg drv
+        echo "开始安装Docker安装完成..."
+        bash /etc/kmodreg docker
+        echo "Docker安装完成,需要重启OPENWRT才能生效！"
     else
-         echo "目前此功能仅限VIP版本提供！"
+            echo "目前此功能仅限VIP版本提供！"
     fi
-    exit
 }

 docker_install(){
     if is_vip; then
-        bash /etc/kmodreg docker
+        echo "开始安装所有驱动..."
+        bash /etc/kmodreg drv
+        echo "所有驱动完成,需要重启OPENWRT才能生效！"
     else
         echo "目前此功能仅限VIP版本提供！"
     fi
-    exit
 }

-case "$1" in
-    "istore")
-        istore_install
-	;;
-    "drv")
-        drv_install
-	;;
-    "docker")
-        docker_install
-	;;
+case $1 in
+    istore)
+        istore_install ;;
+    drv)
+        drv_install ;;
+    docker)
+        docker_install;;
     esac
\ No newline at end of file
--
2.34.1


